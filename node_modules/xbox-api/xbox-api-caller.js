const https = require('https');

var xboxApiCaller = function(url, callback) {
	var xbUrl = {
		host: 'xboxapi.com',
		path: '/v2/' + url,
		// authentication headers
		headers: {
			'X-AUTH': 'e9b6206816485c97bd0b0844073723988a848b3f'
		}
	};

	try {
		https.get(xbUrl, function (res) {
			res.on('data', function(data) {
				var rateLimitRemaining = res.headers['x-ratelimit-remaining'];
				if (rateLimitRemaining > 0) {
					console.log("Calls Left: " + rateLimitRemaining);
					callback(null, res);
				} else {
					var error = new Error("rateLimitExpired", "Rate limit has expired.");
					callback(error, null);
				}
			});

			res.on('error', function(error) {
				if (error.response.statusCode === 404) {
					var error = new Error("xuidNotFound", "The gamertag you entered does not exist. Please try again.");
				}
				callback(error, null);
			});
		});
	} catch (error) {
		// If the API responded with an error message and a payload 
		console.log(error);
	    if (error.response) {
	    	var errorCode = error.response.data.code;
	    	var errorMessage = error.response.data.message;
	    // Otherwise use a generic error message
	    } else {
	    	var errorCode = 500;
	    	var errorMessage = 'Cannot access the API';
	    }
	    // Create an Error object and return it via callback
	    var myError = new Error(errorCode, errorMessage);
	    callback(myError, null);
	}
};

module.exports = xboxApiCaller;